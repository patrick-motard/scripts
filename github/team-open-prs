#!/bin/bash

# Get open PRs from team contributors in active repos
# Usage: team-open-prs [--format markdown|json] [--age days] [--user username] [--no-cache] [--cache-ttl seconds] [repos...]
#   --format: output format (default: markdown)
#   --age: number of days to look back (default: 30)
#   --user: GitHub username to filter by (can be specified multiple times, defaults to contributors YAML)
#   --no-cache: bypass cache and fetch fresh data
#   --cache-ttl: cache lifetime in seconds (default: 300 = 5 minutes)
#   repos: space-separated list of repos in format "org/repo" (default: reads from active repos)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FORMAT="markdown"
DAYS_BACK=30
USERS=()
USE_CACHE=true
CACHE_TTL=300  # 5 minutes

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --format)
            FORMAT="$2"
            shift 2
            ;;
        --format=*)
            FORMAT="${1#*=}"
            shift
            ;;
        --age)
            DAYS_BACK="$2"
            shift 2
            ;;
        --age=*)
            DAYS_BACK="${1#*=}"
            shift
            ;;
        --user)
            USERS+=("$2")
            shift 2
            ;;
        --user=*)
            USERS+=("${1#*=}")
            shift
            ;;
        --no-cache)
            USE_CACHE=false
            shift
            ;;
        --cache-ttl)
            CACHE_TTL="$2"
            shift 2
            ;;
        --cache-ttl=*)
            CACHE_TTL="${1#*=}"
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Remaining arguments are repos
CONFIG_FILE="${HOME}/.config/gh-pr-select/repos.txt"
if [[ $# -eq 0 ]]; then
    # Try to read from config file
    if [[ -f "$CONFIG_FILE" ]]; then
        REPOS=()
        while IFS= read -r line; do
            [[ -n "$line" ]] && REPOS+=("$line")
        done < "$CONFIG_FILE"
    else
        echo "No repos configured. Run 'select-repos' to choose repos to watch." >&2
        echo "[]"
        exit 0
    fi
else
    REPOS=("$@")
fi

# Check if repos array is empty
if [[ ${#REPOS[@]} -eq 0 ]]; then
    echo "No repos configured. Run 'select-repos' to choose repos to watch." >&2
    echo "[]"
    exit 0
fi

# Validate format
if [[ "$FORMAT" != "markdown" && "$FORMAT" != "json" ]]; then
    echo "Error: Invalid format '$FORMAT'. Must be 'markdown' or 'json'." >&2
    exit 1
fi

# Calculate date for PR search (needed for cache key)
if [[ "$OSTYPE" == "darwin"* ]]; then
    DATE_FILTER=$(date -u -v-${DAYS_BACK}d +"%Y-%m-%d")
else
    DATE_FILTER=$(date -u -d "${DAYS_BACK} days ago" +"%Y-%m-%d")
fi

# Determine which users to filter by (needed for cache key)
CONTRIBUTORS_CONFIG="${HOME}/.config/gh-pr-select/contributors.txt"
if [[ ${#USERS[@]} -eq 0 ]]; then
    if [[ -f "$CONTRIBUTORS_CONFIG" ]] && [[ -s "$CONTRIBUTORS_CONFIG" ]]; then
        CONTRIBUTORS=$(cat "$CONTRIBUTORS_CONFIG")
    else
        CONTRIBUTORS_FILE="$SCRIPT_DIR/growth-engine-contributors.yml"
        if [[ -f "$CONTRIBUTORS_FILE" ]]; then
            CONTRIBUTORS=$(grep -E '^\s*-\s+' "$CONTRIBUTORS_FILE" | sed 's/^[[:space:]]*-[[:space:]]*//')
        else
            CONTRIBUTORS=""
        fi
    fi
else
    CONTRIBUTORS=$(printf "%s\n" "${USERS[@]}")
fi

# Check cache EARLY (before slow repo access checks)
CACHE_DIR="${HOME}/.cache/gh-pr-cache"
mkdir -p "$CACHE_DIR"
CACHE_KEY_DATA="${FORMAT}|${DATE_FILTER}|${CONTRIBUTORS}|${REPOS[*]}"
CACHE_KEY=$(echo -n "$CACHE_KEY_DATA" | md5sum 2>/dev/null | cut -d' ' -f1 || echo -n "$CACHE_KEY_DATA" | md5 | cut -d' ' -f1)
CACHE_FILE="${CACHE_DIR}/${CACHE_KEY}.cache"

if [[ "$USE_CACHE" == "true" ]] && [[ -f "$CACHE_FILE" ]]; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
        CACHE_AGE=$(($(date +%s) - $(stat -f %m "$CACHE_FILE")))
    else
        CACHE_AGE=$(($(date +%s) - $(stat -c %Y "$CACHE_FILE")))
    fi
    if [[ $CACHE_AGE -lt $CACHE_TTL ]]; then
        cat "$CACHE_FILE"
        exit 0
    fi
fi

# Function to check repo access
check_repo_access() {
    local repo="$1"
    local auth_test=$(gh api "repos/${repo}" 2>&1)
    if echo "$auth_test" | grep -qi "SAML enforcement\|OAuth token access\|authorization_request"; then
        echo "Warning: Skipping ${repo} - SAML authorization required for ${repo%%/*} org" >&2
        return 1
    fi
    if echo "$auth_test" | grep -qi "Not Found\|Could not resolve"; then
        echo "Warning: Skipping ${repo} - repo not found or inaccessible" >&2
        return 1
    fi
    return 0
}

# Filter repos to only those we can access
ACCESSIBLE_REPOS=()
for repo in "${REPOS[@]}"; do
    if check_repo_access "$repo"; then
        ACCESSIBLE_REPOS+=("$repo")
    fi
done

if [[ ${#ACCESSIBLE_REPOS[@]} -eq 0 ]]; then
    echo "Warning: No accessible repos found" >&2
    if [[ "$FORMAT" == "json" ]]; then
        echo "[]"
    fi
    exit 0
fi

REPOS=("${ACCESSIBLE_REPOS[@]}")

# Build jq filter for contributors
if [[ -z "$CONTRIBUTORS" ]]; then
    JQ_FILTER="true"
else
    JQ_FILTER=$(echo "$CONTRIBUTORS" | while read -r user; do
        [[ -n "$user" ]] && echo ".author.login == \"$user\""
    done | paste -sd '|' - | sed 's/|/ or /g')
    [[ -z "$JQ_FILTER" ]] && JQ_FILTER="true"
fi

# Fetch PRs based on format and cache the result
if [[ "$FORMAT" == "json" ]]; then
    # First get basic PR list - fetch repos in parallel
    echo "Fetching PR lists from ${#REPOS[@]} repos (parallel)..." >&2
    PR_LIST=$(mktemp)
    TEMP_DIR=$(mktemp -d)

    # Fetch each repo in parallel
    for REPO in "${REPOS[@]}"; do
        REPO_SHORT="${REPO#*/}"
        (
            echo "  - ${REPO_SHORT}..." >&2
            gh pr list --repo "$REPO" --state open --search "created:>=$DATE_FILTER" \
                --json author,createdAt,title,number,url,isDraft,labels 2>/dev/null | \
                jq -c ".[] | select($JQ_FILTER) | . + {repo: \"$REPO_SHORT\", fullRepo: \"$REPO\"}" > "$TEMP_DIR/${REPO_SHORT}.json"
        ) &
    done

    # Wait for all repo fetches to complete
    wait

    # Combine all repo results
    cat "$TEMP_DIR"/*.json 2>/dev/null > "$PR_LIST"
    rm -rf "$TEMP_DIR"

    # Count PRs and fetch full details in parallel
    TOTAL_PRS=$(wc -l < "$PR_LIST" | tr -d ' ')
    if [[ "$TOTAL_PRS" -eq 0 ]]; then
        echo "[]" | tee "$CACHE_FILE"
        rm -f "$PR_LIST"
    else
        echo "Fetching details for ${TOTAL_PRS} PRs (parallel)..." >&2
        DETAILS_DIR=$(mktemp -d)

        # Fetch PR details in parallel (max 8 concurrent)
        COUNT=0
        while IFS= read -r pr; do
            COUNT=$((COUNT + 1))
            PR_URL=$(echo "$pr" | jq -r '.url')
            PR_NUM=$(echo "$pr" | jq -r '.number')
            REPO=$(echo "$pr" | jq -r '.repo')

            (
                echo "  [$COUNT/$TOTAL_PRS] ${REPO}#${PR_NUM}..." >&2
                # Get full PR details and merge with list data, extract Jira ticket
                gh pr view "$PR_URL" --json state,updatedAt,comments,body,reviews 2>/dev/null | \
                    jq -c ". + $(echo "$pr") |
                        .jiraTicket = (if .body then ((.body | match(\"https://zendesk\\\\.atlassian\\\\.net/browse/(?<ticket>[A-Z]+-[0-9]+)\") | .captures[0].string) // null) else null end) |
                        .jiraUrl = (if .jiraTicket then \"https://zendesk.atlassian.net/browse/\" + .jiraTicket else null end)" \
                    > "$DETAILS_DIR/pr-${COUNT}.json"
            ) &

            # Limit to 8 concurrent fetches
            if (( COUNT % 8 == 0 )); then
                wait
            fi
        done < "$PR_LIST"

        # Wait for remaining fetches
        wait

        # Combine all results into array
        jq -s '.' "$DETAILS_DIR"/pr-*.json | tee "$CACHE_FILE"

        rm -rf "$PR_LIST" "$DETAILS_DIR"
        echo "Done! Cached ${TOTAL_PRS} PRs" >&2
    fi
else
    # Markdown table format
    {
        printf "REPO | DATE | AUTHOR | TITLE | LINK\n"
        printf "%s\n" "--- | --- | --- | --- | ---"

        for REPO in "${REPOS[@]}"; do
            REPO_SHORT="${REPO#*/}"
            gh pr list --repo "$REPO" --state open --search "created:>=$DATE_FILTER" \
                --json author,createdAt,title,number,url 2>/dev/null | \
                jq -r ".[] | select($JQ_FILTER) | [\"$REPO_SHORT\", .createdAt[:10], .author.login, .title, .url] | join(\" | \")"
        done
    } | tee "$CACHE_FILE"
fi
