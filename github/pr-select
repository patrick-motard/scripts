#!/bin/bash

# Interactive PR selector using fzf
# Usage: pr-select [team-open-prs options...]
#   All options are passed to team-open-prs
#   Keybindings:
#     Ctrl-R: Reload/refresh cache
#     Ctrl-S: Sort options
#     Ctrl-F: Filter options
#     Ctrl-X: Mark all as seen (reset change baseline)
#     Ctrl-M: Mark selected PR as seen
#     Ctrl-E: Edit watched repos
#     Ctrl-U: Edit watched users/contributors
#     Ctrl-O: Settings (age, cache TTL, refresh interval)
#
#   Change indicators:
#     * (magenta): Your PR has new activity
#     * (yellow): Other PR has new activity
#     [+Nc +Nr STATUS]: New comments, reviews, or approval status change

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/.pr-config"

CACHE_DIR="${HOME}/.cache/gh-pr-cache"
REPOS_FILE="${HOME}/.config/gh-pr-select/repos.txt"
CHANGES_FILE="${CACHE_DIR}/changes.json"

# Load config values
AGE_DAYS=$(get_config age_days 28)
CACHE_TTL_MINUTES=$(get_config cache_ttl_minutes 29)
CACHE_TTL_SECONDS=$(minutes_to_seconds "$CACHE_TTL_MINUTES")

# Check if repos are configured, if not prompt for selection
if [[ ! -f "$REPOS_FILE" ]] || [[ ! -s "$REPOS_FILE" ]]; then
    echo "No repos configured for PR watching."
    echo "Let's select some repos you've worked in recently..."
    echo ""
    "$SCRIPT_DIR/select-repos"
    if [[ ! -f "$REPOS_FILE" ]] || [[ ! -s "$REPOS_FILE" ]]; then
        echo "No repos selected. Exiting."
        exit 0
    fi
fi

# Default sort/filter settings
SORT_BY="date"  # date, author, status, comments, repo
SORT_ORDER="desc"  # asc, desc
FILTER_STATUS=""  # "", draft, review, approved
FILTER_REPO=""  # "", specific repo name

# Check for required commands
if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed" >&2
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed" >&2
    exit 1
fi

# Determine clipboard command based on OS
if command -v pbcopy &> /dev/null; then
    CLIP_CMD="pbcopy"
elif command -v xclip &> /dev/null; then
    CLIP_CMD="xclip -selection clipboard"
elif command -v xsel &> /dev/null; then
    CLIP_CMD="xsel --clipboard --input"
else
    CLIP_CMD=""
fi

# Load changes data if available
load_changes() {
    if [[ -f "$CHANGES_FILE" ]]; then
        cat "$CHANGES_FILE"
    else
        echo '{"myPRs":{},"otherPRs":{}}'
    fi
}

# Main loop to allow refresh
REFRESH_MARKER="/tmp/pr-select-refresh-$$"
RESET_MARKER="/tmp/pr-select-reset-$$"
SETTINGS_MARKER="/tmp/pr-select-settings-$$"
MARK_SEEN_MARKER="/tmp/pr-select-mark-seen-$$"
trap "rm -f $REFRESH_MARKER $RESET_MARKER $SETTINGS_MARKER $MARK_SEEN_MARKER" EXIT

while true; do
    # Reload config values (may have changed via settings menu)
    AGE_DAYS=$(get_config age_days 28)
    CACHE_TTL_MINUTES=$(get_config cache_ttl_minutes 29)
    CACHE_TTL_SECONDS=$(minutes_to_seconds "$CACHE_TTL_MINUTES")

    # Fetch PRs as JSON (show progress)
    echo "Loading PRs (age: ${AGE_DAYS}d, cache TTL: ${CACHE_TTL_MINUTES}m)..." >&2
    PR_JSON=$("$SCRIPT_DIR/team-open-prs" --format json --age "$AGE_DAYS" --cache-ttl "$CACHE_TTL_SECONDS" "$@" 2>&2)
    echo "" >&2

    if [[ -z "$PR_JSON" ]] || [[ "$PR_JSON" == "[]" ]]; then
        # Show config menu instead of exiting
        REPOS_FILE="${HOME}/.config/gh-pr-select/repos.txt"
        CURRENT_REPOS=$(cat "$REPOS_FILE" 2>/dev/null | tr '\n' ', ' | sed 's/,$//')

        echo "No PRs found in watched repos."
        echo ""
        ACTION=$(printf "Edit watched repos\nEdit contributors\nRefresh\nExit" | fzf \
            --header="Current repos: ${CURRENT_REPOS:-none}" \
            --prompt="What would you like to do? > ")

        case "$ACTION" in
            "Edit watched repos")
                "$SCRIPT_DIR/select-repos"
                rm -rf "$CACHE_DIR"/*
                continue
                ;;
            "Edit contributors")
                "$SCRIPT_DIR/select-contributors"
                rm -rf "$CACHE_DIR"/*
                continue
                ;;
            "Refresh")
                rm -rf "$CACHE_DIR"/*
                continue
                ;;
            *)
                exit 0
                ;;
        esac
    fi

    # Save JSON to temp file for preview lookups
    PR_JSON_FILE=$(mktemp)
    echo "$PR_JSON" > "$PR_JSON_FILE"
    trap "rm -f $PR_JSON_FILE" EXIT

    # Apply filters
    FILTERED_JSON="$PR_JSON"
    if [[ -n "$FILTER_STATUS" ]]; then
        case "$FILTER_STATUS" in
            "draft")
                FILTERED_JSON=$(echo "$FILTERED_JSON" | jq '[.[] | select(.isDraft == true)]')
                ;;
            "approved")
                FILTERED_JSON=$(echo "$FILTERED_JSON" | jq '[.[] | select([.reviews[].state] | any(. == "APPROVED"))]')
                ;;
            "review")
                FILTERED_JSON=$(echo "$FILTERED_JSON" | jq '[.[] | select(.isDraft == false and ([.reviews[].state] | any(. == "APPROVED") | not))]')
                ;;
        esac
    fi

    if [[ -n "$FILTER_REPO" ]]; then
        FILTERED_JSON=$(echo "$FILTERED_JSON" | jq --arg repo "$FILTER_REPO" '[.[] | select(.repo == $repo)]')
    fi

    # Apply sorting
    case "$SORT_BY" in
        "date")
            if [[ "$SORT_ORDER" == "asc" ]]; then
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.createdAt)')
            else
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.createdAt) | reverse')
            fi
            ;;
        "author")
            if [[ "$SORT_ORDER" == "asc" ]]; then
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.author.login)')
            else
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.author.login) | reverse')
            fi
            ;;
        "status")
            # Draft=0, Review=1, Approved=2
            SORTED_JSON=$(echo "$FILTERED_JSON" | jq '[.[] | . + {
                statusOrder: (if .isDraft then 0 elif ([.reviews[].state] | any(. == "APPROVED")) then 2 else 1 end)
            }] | sort_by(.statusOrder)')
            if [[ "$SORT_ORDER" == "desc" ]]; then
                SORTED_JSON=$(echo "$SORTED_JSON" | jq 'reverse')
            fi
            ;;
        "comments")
            if [[ "$SORT_ORDER" == "asc" ]]; then
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.comments | length)')
            else
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.comments | length) | reverse')
            fi
            ;;
        "repo")
            if [[ "$SORT_ORDER" == "asc" ]]; then
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.repo)')
            else
                SORTED_JSON=$(echo "$FILTERED_JSON" | jq 'sort_by(.repo) | reverse')
            fi
            ;;
        *)
            SORTED_JSON="$FILTERED_JSON"
            ;;
    esac

    # Check if any PRs have Jira tickets
    HAS_JIRA=$(echo "$SORTED_JSON" | jq '[.[].jiraTicket // null | select(. != null)] | length > 0')

    # Load changes for highlighting
    CHANGES_JSON=$(load_changes)

    # Calculate max column widths from data
    MAX_AUTHOR=$(echo "$SORTED_JSON" | jq -r '[.[].author.login | length] | max')
    MAX_REPO=$(echo "$SORTED_JSON" | jq -r '[.[].repo | length] | max')
    if [[ "$HAS_JIRA" == "true" ]]; then
        MAX_JIRA=$(echo "$SORTED_JSON" | jq -r '[.[] | (.jiraTicket // "") | length] | max')
        [[ "$MAX_JIRA" -gt 15 ]] && MAX_JIRA=15  # Cap Jira at 15
    fi

    # Format PRs for fzf display with colors and aligned columns
    # Colors: Gray (date), Blue (author), Yellow (jira), Green (repo), White (title), Status (Draft/Review/Approved)
    # Keep data separated by │ for parsing, but pad for alignment
    # Include PR number and URLs for lookup (hidden from display)

    # Build column header row
    COL_DATE=$(printf "%-10s" "DATE")
    COL_AUTHOR=$(printf "%-${MAX_AUTHOR}s" "AUTHOR")
    COL_REPO=$(printf "%-${MAX_REPO}s" "REPO")
    COL_STATUS=$(printf "%-8s" "STATUS")

    if [[ "$HAS_JIRA" == "true" ]]; then
        COL_JIRA=$(printf "%-${MAX_JIRA}s" "JIRA")
        HEADER_ROW="\033[1;97m  ${COL_DATE}│${COL_AUTHOR}│${COL_JIRA}│${COL_REPO}│${COL_STATUS}│TITLE\033[0m│││"
        PR_DISPLAY=$(echo -e "$HEADER_ROW"; echo "$SORTED_JSON" | jq -r --argjson aw "$MAX_AUTHOR" --argjson rw "$MAX_REPO" --argjson jw "$MAX_JIRA" --argjson changes "$CHANGES_JSON" '.[] |
            (.jiraTicket // "" | .[0:15]) as $jira |
            (.url) as $url |
            # Check if this PR has changes
            (if ($changes.myPRs[$url] != null) then "\u001b[1;35m* \u001b[0m"
             elif ($changes.otherPRs[$url] != null) then "\u001b[33m* \u001b[0m"
             else "  "
             end) as $changeMarker |
            # Build change suffix for title
            (if ($changes.myPRs[$url] != null) then
                " \u001b[35m[" + ([
                    (if $changes.myPRs[$url].newComments then "+\($changes.myPRs[$url].newComments)c" else empty end),
                    (if $changes.myPRs[$url].newReviews then "+\($changes.myPRs[$url].newReviews)r" else empty end),
                    (if $changes.myPRs[$url].approvalChanged then $changes.myPRs[$url].newApprovalStatus else empty end),
                    (if $changes.myPRs[$url].isNew then "NEW" else empty end)
                ] | join(" ")) + "]\u001b[0m"
             elif ($changes.otherPRs[$url] != null) then
                " \u001b[33m[" + ([
                    (if $changes.otherPRs[$url].newComments then "+\($changes.otherPRs[$url].newComments)c" else empty end),
                    (if $changes.otherPRs[$url].newReviews then "+\($changes.otherPRs[$url].newReviews)r" else empty end),
                    (if $changes.otherPRs[$url].approvalChanged then $changes.otherPRs[$url].newApprovalStatus else empty end),
                    (if $changes.otherPRs[$url].isNew then "NEW" else empty end)
                ] | join(" ")) + "]\u001b[0m"
             else ""
             end) as $changeSuffix |
            (
                if .isDraft then "\u001b[34mDraft\u001b[0m   "
                elif ([.reviews[].state] | any(. == "APPROVED")) then "\u001b[32mApproved\u001b[0m"
                else "\u001b[33mReview\u001b[0m  "
                end
            ) as $status |
            $changeMarker +
            "\u001b[90m\(.createdAt[:10])\u001b[0m│" +
            "\u001b[34m\(.author.login + (" " * ($aw - (.author.login | length))))\u001b[0m│" +
            "\u001b[33m" + ($jira + (" " * ($jw - ($jira | length)))) + "\u001b[0m│" +
            "\u001b[32m\(.repo + (" " * ($rw - (.repo | length))))\u001b[0m│" +
            $status + "│" +
            "\(.title)" + $changeSuffix + " " +
            "│\(.number)│\(.url)│\(.jiraUrl // "")"')
    else
        HEADER_ROW="\033[1;97m  ${COL_DATE}│${COL_AUTHOR}│${COL_REPO}│${COL_STATUS}│TITLE\033[0m│││"
        PR_DISPLAY=$(echo -e "$HEADER_ROW"; echo "$SORTED_JSON" | jq -r --argjson aw "$MAX_AUTHOR" --argjson rw "$MAX_REPO" --argjson changes "$CHANGES_JSON" '.[] |
            (.url) as $url |
            # Check if this PR has changes
            (if ($changes.myPRs[$url] != null) then "\u001b[1;35m* \u001b[0m"
             elif ($changes.otherPRs[$url] != null) then "\u001b[33m* \u001b[0m"
             else "  "
             end) as $changeMarker |
            # Build change suffix for title
            (if ($changes.myPRs[$url] != null) then
                " \u001b[35m[" + ([
                    (if $changes.myPRs[$url].newComments then "+\($changes.myPRs[$url].newComments)c" else empty end),
                    (if $changes.myPRs[$url].newReviews then "+\($changes.myPRs[$url].newReviews)r" else empty end),
                    (if $changes.myPRs[$url].approvalChanged then $changes.myPRs[$url].newApprovalStatus else empty end),
                    (if $changes.myPRs[$url].isNew then "NEW" else empty end)
                ] | join(" ")) + "]\u001b[0m"
             elif ($changes.otherPRs[$url] != null) then
                " \u001b[33m[" + ([
                    (if $changes.otherPRs[$url].newComments then "+\($changes.otherPRs[$url].newComments)c" else empty end),
                    (if $changes.otherPRs[$url].newReviews then "+\($changes.otherPRs[$url].newReviews)r" else empty end),
                    (if $changes.otherPRs[$url].approvalChanged then $changes.otherPRs[$url].newApprovalStatus else empty end),
                    (if $changes.otherPRs[$url].isNew then "NEW" else empty end)
                ] | join(" ")) + "]\u001b[0m"
             else ""
             end) as $changeSuffix |
            (
                if .isDraft then "\u001b[34mDraft\u001b[0m   "
                elif ([.reviews[].state] | any(. == "APPROVED")) then "\u001b[32mApproved\u001b[0m"
                else "\u001b[33mReview\u001b[0m  "
                end
            ) as $status |
            $changeMarker +
            "\u001b[90m\(.createdAt[:10])\u001b[0m│" +
            "\u001b[34m\(.author.login + (" " * ($aw - (.author.login | length))))\u001b[0m│" +
            "\u001b[32m\(.repo + (" " * ($rw - (.repo | length))))\u001b[0m│" +
            $status + "│" +
            "\(.title)" + $changeSuffix + " " +
            "│\(.number)│\(.url)│"')
    fi

    # Get unique repos for filter menu
    REPOS=($(echo "$PR_JSON" | jq -r '[.[].repo] | unique | .[]'))

    # Build header with current sort/filter
    # Count changes for header display
    MY_CHANGES_COUNT=$(echo "$CHANGES_JSON" | jq '.myPRs | length')
    OTHER_CHANGES_COUNT=$(echo "$CHANGES_JSON" | jq '.otherPRs | length')
    if [[ "$MY_CHANGES_COUNT" -gt 0 ]] || [[ "$OTHER_CHANGES_COUNT" -gt 0 ]]; then
        CHANGES_INDICATOR=" | Changes: ${MY_CHANGES_COUNT} mine, ${OTHER_CHANGES_COUNT} other"
    else
        CHANGES_INDICATOR=""
    fi
    HEADER="Sort: $SORT_BY ($SORT_ORDER) | Filter: status=${FILTER_STATUS:-all} repo=${FILTER_REPO:-all}${CHANGES_INDICATOR}"
    HEADER="$HEADER | ^S:Sort ^F:Filter ^R:Refresh ^M:MarkSeen ^X:MarkAllSeen ^O:Settings ^E:Repos ^U:Users"

    # Determine which columns to show based on whether Jira is present
    if [[ "$HAS_JIRA" == "true" ]]; then
        FZF_WITH_NTH="1,2,3,4,5,6"
        PR_NUM_FIELD=7
    else
        FZF_WITH_NTH="1,2,3,4,5"
        PR_NUM_FIELD=6
    fi

    # Define marker files for sort/filter state
    SORT_MARKER="/tmp/pr-select-sort-$$"
    FILTER_MARKER="/tmp/pr-select-filter-$$"

    # Select PR with fzf with detailed preview
    SELECTED=$(echo "$PR_DISPLAY" | FZF_PR_JSON="$PR_JSON_FILE" FZF_CHANGES_FILE="$CHANGES_FILE" PR_NUM_FIELD="$PR_NUM_FIELD" HAS_JIRA="$HAS_JIRA" fzf \
        --ansi \
        --layout=reverse \
        --header="$HEADER" \
        --header-lines=1 \
        --delimiter="│" \
        --with-nth="$FZF_WITH_NTH" \
        --bind="ctrl-r:execute-silent(rm -rf $CACHE_DIR/* && touch $REFRESH_MARKER)+abort" \
        --bind="ctrl-x:execute-silent($SCRIPT_DIR/pr-cache-refresh --reset && touch $RESET_MARKER)+abort" \
        --bind="ctrl-m:execute-silent(echo {} | cut -d'│' -f\$((PR_NUM_FIELD + 1)) > $MARK_SEEN_MARKER)+abort" \
        --bind="ctrl-s:execute(bash -c \"$SCRIPT_DIR/.pr-sort-menu $SORT_BY $SORT_ORDER > $SORT_MARKER\")+abort" \
        --bind="ctrl-f:execute(bash -c \"$SCRIPT_DIR/.pr-filter-menu '$FILTER_STATUS' '$FILTER_REPO' ${REPOS[*]} > $FILTER_MARKER\")+abort" \
        --bind="ctrl-o:execute(bash -c \"$SCRIPT_DIR/.pr-settings-menu > $SETTINGS_MARKER\")+abort" \
        --bind="ctrl-e:execute($SCRIPT_DIR/select-repos)+execute-silent(rm -rf $CACHE_DIR/* && touch $REFRESH_MARKER)+abort" \
        --bind="ctrl-u:execute($SCRIPT_DIR/select-contributors)+execute-silent(rm -rf $CACHE_DIR/* && touch $REFRESH_MARKER)+abort" \
        --preview='
            PR_NUM=$(echo {} | cut -d"│" -f$PR_NUM_FIELD)
            PR_URL=$(echo {} | cut -d"│" -f$((PR_NUM_FIELD + 1)))
            '"$SCRIPT_DIR"'/.pr-preview "$PR_NUM" "$PR_URL" "$FZF_PR_JSON" "$FZF_CHANGES_FILE"
        ' \
        --preview-window=up:60%:wrap)

    FZF_EXIT_CODE=$?
    rm -f "$PR_JSON_FILE"

    # Check if user changed sort
    if [[ -f "$SORT_MARKER" ]]; then
        SORT_RESULT=$(cat "$SORT_MARKER")
        rm -f "$SORT_MARKER"
        if [[ "$SORT_RESULT" != "cancel" ]] && [[ -n "$SORT_RESULT" ]]; then
            SORT_BY="${SORT_RESULT%:*}"
            SORT_ORDER="${SORT_RESULT#*:}"
        fi
        continue
    fi

    # Check if user changed filter
    if [[ -f "$FILTER_MARKER" ]]; then
        FILTER_RESULT=$(cat "$FILTER_MARKER")
        rm -f "$FILTER_MARKER"
        if [[ "$FILTER_RESULT" == "clear" ]]; then
            FILTER_STATUS=""
            FILTER_REPO=""
        elif [[ "$FILTER_RESULT" != "cancel" ]] && [[ -n "$FILTER_RESULT" ]]; then
            FILTER_TYPE="${FILTER_RESULT%:*}"
            FILTER_VALUE="${FILTER_RESULT#*:}"
            if [[ "$FILTER_TYPE" == "status" ]]; then
                FILTER_STATUS="$FILTER_VALUE"
            elif [[ "$FILTER_TYPE" == "repo" ]]; then
                FILTER_REPO="$FILTER_VALUE"
            fi
        fi
        continue
    fi

    # Check if user changed settings
    if [[ -f "$SETTINGS_MARKER" ]]; then
        SETTINGS_RESULT=$(cat "$SETTINGS_MARKER")
        rm -f "$SETTINGS_MARKER"
        if [[ "$SETTINGS_RESULT" == "settings_changed" ]]; then
            echo "Settings updated. Clearing cache and refreshing..."
            rm -rf "$CACHE_DIR"/*
        fi
        continue
    fi

    # Check if user pressed Ctrl-R (marker file exists)
    if [[ -f "$REFRESH_MARKER" ]]; then
        rm -f "$REFRESH_MARKER"
        echo "Refreshing..."
        continue
    fi

    # Check if user pressed Ctrl-X (reset marker file exists)
    if [[ -f "$RESET_MARKER" ]]; then
        rm -f "$RESET_MARKER"
        echo "Baseline reset - all PR activity marked as seen"
        continue
    fi

    # Check if user pressed Ctrl-M (mark seen marker file exists)
    if [[ -f "$MARK_SEEN_MARKER" ]]; then
        PR_URL=$(cat "$MARK_SEEN_MARKER")
        rm -f "$MARK_SEEN_MARKER"
        if [[ -n "$PR_URL" ]]; then
            echo "Marking PR as seen: $PR_URL"
            "$SCRIPT_DIR/pr-cache-refresh" --mark-seen "$PR_URL"
            echo "PR marked as seen. Refreshing..."
        fi
        continue
    fi

    # Exit loop if no selection (ESC or Ctrl-C)
    if [[ -z "$SELECTED" ]]; then
        exit 0
    fi

    # Save HAS_JIRA for use after loop
    SELECTED_HAS_JIRA="$HAS_JIRA"

    # Break out of loop to process selection
    break
done

# Extract PR details (strip ANSI color codes)
# Column layout depends on whether Jira column was shown
SELECTED_CLEAN=$(echo "$SELECTED" | sed 's/\x1b\[[0-9;]*m//g')
PR_DATE=$(echo "$SELECTED_CLEAN" | cut -d'│' -f1 | xargs)
PR_AUTHOR=$(echo "$SELECTED_CLEAN" | cut -d'│' -f2 | xargs)

if [[ "$SELECTED_HAS_JIRA" == "true" ]]; then
    # With Jira: date│author│jira│repo│status│title│number│url│jiraUrl
    PR_JIRA=$(echo "$SELECTED_CLEAN" | cut -d'│' -f3 | xargs)
    PR_REPO=$(echo "$SELECTED_CLEAN" | cut -d'│' -f4 | xargs)
    PR_APPROVED=$(echo "$SELECTED_CLEAN" | cut -d'│' -f5 | xargs)
    PR_TITLE=$(echo "$SELECTED_CLEAN" | cut -d'│' -f6 | xargs)
    PR_NUMBER=$(echo "$SELECTED_CLEAN" | cut -d'│' -f7 | xargs)
    PR_URL=$(echo "$SELECTED_CLEAN" | cut -d'│' -f8 | xargs)
    PR_JIRA_URL=$(echo "$SELECTED_CLEAN" | cut -d'│' -f9 | xargs)
else
    # Without Jira: date│author│repo│status│title│number│url│
    PR_JIRA=""
    PR_REPO=$(echo "$SELECTED_CLEAN" | cut -d'│' -f3 | xargs)
    PR_APPROVED=$(echo "$SELECTED_CLEAN" | cut -d'│' -f4 | xargs)
    PR_TITLE=$(echo "$SELECTED_CLEAN" | cut -d'│' -f5 | xargs)
    PR_NUMBER=$(echo "$SELECTED_CLEAN" | cut -d'│' -f6 | xargs)
    PR_URL=$(echo "$SELECTED_CLEAN" | cut -d'│' -f7 | xargs)
    PR_JIRA_URL=""
fi

# Build action menu dynamically based on whether Jira exists
if [[ -n "$PR_JIRA_URL" ]]; then
    ACTION=$(printf "Open PR in browser\nOpen Jira in browser\nCopy PR URL\nCopy Jira URL\nCopy title\nCancel" | fzf \
        --header="What would you like to do?" \
        --height=10)
else
    ACTION=$(printf "Open PR in browser\nCopy PR URL\nCopy title\nCancel" | fzf \
        --header="What would you like to do?" \
        --height=8)
fi

case "$ACTION" in
    "Open PR in browser")
        if command -v open &> /dev/null; then
            open "$PR_URL"
        elif command -v xdg-open &> /dev/null; then
            xdg-open "$PR_URL"
        else
            echo "Error: Cannot open browser" >&2
            exit 1
        fi
        echo "Opened $PR_URL"
        ;;
    "Open Jira in browser")
        if command -v open &> /dev/null; then
            open "$PR_JIRA_URL"
        elif command -v xdg-open &> /dev/null; then
            xdg-open "$PR_JIRA_URL"
        else
            echo "Error: Cannot open browser" >&2
            exit 1
        fi
        echo "Opened $PR_JIRA_URL"
        ;;
    "Copy PR URL")
        if [[ -z "$CLIP_CMD" ]]; then
            echo "Error: No clipboard command available" >&2
            exit 1
        fi
        echo -n "$PR_URL" | eval "$CLIP_CMD"
        echo "Copied PR URL to clipboard: $PR_URL"
        ;;
    "Copy Jira URL")
        if [[ -z "$CLIP_CMD" ]]; then
            echo "Error: No clipboard command available" >&2
            exit 1
        fi
        echo -n "$PR_JIRA_URL" | eval "$CLIP_CMD"
        echo "Copied Jira URL to clipboard: $PR_JIRA_URL"
        ;;
    "Copy title")
        if [[ -z "$CLIP_CMD" ]]; then
            echo "Error: No clipboard command available" >&2
            exit 1
        fi
        echo -n "$PR_TITLE" | eval "$CLIP_CMD"
        echo "Copied title to clipboard: $PR_TITLE"
        ;;
    "Cancel"|"")
        echo "Cancelled"
        exit 0
        ;;
esac
